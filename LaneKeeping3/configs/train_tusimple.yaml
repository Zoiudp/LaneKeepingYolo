# Training configuration for TuSimple dataset
# Extends base.yaml with training-specific settings

# Include base configuration
defaults:
  - base

# Model configuration
model:
  backbone_variant: "m"  # Medium variant for good accuracy/speed tradeoff
  input_size: [640, 640]
  num_keypoints: 72
  num_lanes: 4
  use_polynomial: true

# Data configuration
data:
  dataset_type: "tusimple"
  train_dir: "data/tusimple/train"
  val_dir: "data/tusimple/val"
  test_dir: "data/tusimple/test"
  num_workers: 8

# Training configuration
training:
  # Staged training schedule
  # Stage 1: Pretrain backbone on ImageNet (optional, can use pretrained)
  # Stage 2: Train full model
  # Stage 3: Fine-tune with hard examples
  
  # Total epochs
  epochs: 100
  
  # Batch size (adjust based on GPU memory)
  batch_size: 16
  
  # Learning rate
  learning_rate: 1e-4
  
  # Weight decay for AdamW
  weight_decay: 0.01
  
  # Optimizer
  optimizer: "adamw"
  
  # Learning rate scheduler
  scheduler: "cosine"
  min_lr: 1e-6
  
  # Warmup epochs
  warmup_epochs: 5
  warmup_lr: 1e-6
  
  # Gradient clipping
  max_grad_norm: 10.0
  
  # Mixed precision training
  amp: true
  
  # Exponential moving average
  ema: true
  ema_decay: 0.9999
  
  # Label smoothing
  label_smoothing: 0.1
  
  # Number of data loading workers
  num_workers: 8
  
  # Pin memory for faster data transfer
  pin_memory: true
  
  # Resume from checkpoint
  resume: null
  
  # Pretrained weights (for transfer learning)
  pretrained: null

# Augmentation (stronger for training)
augmentation:
  horizontal_flip: true
  horizontal_flip_prob: 0.5
  
  rotation: true
  rotation_limit: 15
  
  scale: true
  scale_limit: 0.15
  
  translate: true
  translate_limit: 0.15
  
  brightness_contrast: true
  brightness_limit: 0.3
  contrast_limit: 0.3
  
  color_jitter: true
  hue_shift_limit: 15
  saturation_limit: 0.3
  
  blur: true
  blur_limit: 7
  blur_prob: 0.3
  
  noise: true
  noise_var_limit: [10, 60]
  noise_prob: 0.3
  
  weather: true
  rain_prob: 0.15
  fog_prob: 0.15
  
  shadow: true
  shadow_prob: 0.3
  
  cutout: true
  cutout_prob: 0.3
  cutout_num_holes: 4
  cutout_max_size: 80

# Loss weights
loss:
  keypoint_weight: 1.0
  polynomial_weight: 1.0
  classification_weight: 0.5
  confidence_weight: 1.0
  segmentation_weight: 0.5
  temporal_weight: 0.0  # Disable for static images
  focal_gamma: 2.0

# Output configuration
output_dir: "outputs/train_tusimple"

# Logging
logging:
  level: "info"
  tensorboard: true
  wandb: false
  save_interval: 10
  val_interval: 1

# Device
device: "cuda"
